<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta name="keywords" content="bingcheng HU, 胡炳城, blogs, papers, Machine Learning, Artificial Intelligence" />
    <title>
        JAZZ IT UP
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://bingcheng.openmc.cn/resources/small.png" />
     
<link rel="stylesheet" href="/blog/css/style.css">


    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css" />
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@2.0.0/dist/main.js"></script>

    <script>
        infiniteScroll()

        window.addEventListener('DOMContentLoaded', function () {
            const [
                mainTitle,
                mobileMenu,
                mobileMainTitle,
                mobileMenuBtn,
                ipadMenuBtn,
                aside,
                closeBtn,
            ] = getEle(
                '#main-title',
                '.mobile-menu',
                '.mobile-menu h3',
                '.mobile-menu button',
                '.ipad-menu',
                'aside',
                'aside .close',
            )
            const io = new IntersectionObserver(entries => {
                if (entries[0].intersectionRatio <= 0) {
                    mobileMainTitle.classList.remove('invisibile')
                } else {
                    mobileMainTitle.classList.add('invisibile')
                }
            })
            io.observe(mainTitle)

            clickToggleAside(mobileMenuBtn)
            clickToggleAside(ipadMenuBtn)
            clickToggleAside(closeBtn, false)

            const isMenuVisible = window.getComputedStyle(mobileMenu).display !== 'none'
            if (isMenuVisible) document.body.style.background = 'none'

            function getEle(...args) {
                return args.map(arg => document.querySelector(arg))
            }

            function clickToggleAside(btn, show = true) {
                btn.addEventListener('click', function () {
                    if (show) {
                        aside.style.display = 'block'
                    } else {
                        aside.style.display = 'none'
                    }
                })
            }
        })
    </script>
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R8Y6DPG1BC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-R8Y6DPG1BC');
</script>
<!-- End Google Analytics -->


    

<!-- Global site tag (hm.js) - Baidu Analytics -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?736ceb6473823581e338e5ea410a1f7e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.2.0"></head>

<body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
    <div class="container">
        <header class="header">
    <nav class="mobile-menu" style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <h3 class="invisibile">
            <a href="/blog/" class="logo">
                JAZZ IT UP
            </a>
        </h3>
        <button class="menu">menu</button>
    </nav>

    <button class="ipad-menu menu">menu</button>

    <h1 class="title" id="main-title">
        <a href="/blog/" class="logo">
            JAZZ IT UP
        </a>
    </h1>
    <h2 class="desc">
        keep going, keep learning
    </h2>

    <div class="links">
        <ul>
            
            <li>
                <a href="https://bingcheng.openmc.cn">
                    home
                </a>
            </li>
            
            <li>
                <a href="https://bingcheng.openmc.cn/about/">
                    about
                </a>
            </li>
            
            <li>
                <a href="https://bingcheng.openmc.cn/blog-zh/">
                    ·  中文
                </a>
            </li>
            
        </ul>
    </div>
</header>
        <main class="main">
            <article class="post">
    
        
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            processEscapes: true
          }
        });
      </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
            tex2jax: {
              skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
          });
      </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
              var all = MathJax.Hub.getAllJax(), i;
              for(i=0; i < all.length; i += 1) {
                  all[i].SourceElement().parentNode.className += ' has-jax';
              }
          });
      </script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
    
    
    
    <h2 class="post-title">
        Spatial Audio
    </h2>
    <ul class="post-date">
        <li>
            2021-12-04
        </li>
        <li>
            胡炳城, Bingcheng
        </li>
    </ul>
    <div class="post-content">
        <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx2o0sv5umj307g0b4js7.jpg" /></p>
<div style="page-break-after: always;">

</div>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3xUkar0kqto" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<h2 id="abstract">Abstract</h2>
<p>Nowadays, as apple comes up with AirPods 3, spatial audio is much hot and everyone wants to try what’s spatial audio. But all the devices that support spatial audio are expensive. So the implementation of spatial audio with cheap devices is useful. In this project, gyroscopes inside smartphones and front cameras of phones and computers are used as tools to support spatial audio. The webpage to demonstrate this idea can be found <a target="_blank" rel="noopener" href="https://spatialaudio.omniai.org/">here</a>.</p>
<h2 id="introduction">Introduction</h2>
<h3 id="spatial-audio">Spatial audio</h3>
<p>Why do we need spatial audio? Actually, in early theaters, the sound system had only one channel. Until one day Blumlein visits the cinema with his wife, and he feels that one channel is strange because it hears like the sounds only come from one person.</p>
<p>Then come the stereo signal. Stereo panning is the simplest implementation of spatial audio, which works just like the real world, and all users were satisfied with stereo panning. But as technology develops, people thought just 2 channels are not able to fulfill users’ pursue of real spatial audio: audio comes from all directions.</p>
<p>Then surrounding audio came up, which used 7 speakers from the front, front left, front right, left, right, back left, and back right. This system is quite amazing and still used in many cinemas today.</p>
<p>But a system with many speakers could be expensive and not everyone can have a place to arrange this system, then comes calculated spatial audio.</p>
<h3 id="head-related-transfer-function-implementation">Head-Related Transfer Function Implementation</h3>
<p>Head-Related Transfer Function (HRTF) is used in this project, which is one of the best implementations of calculated spatial audio.</p>
<p>Human ears are lowpass filters and can produce significant attenuation. when a person turns his or her head left and right, the sound could be different. And this is why people can tell where is the source for the audio.</p>
<p>With an effective radius of head <span class="math inline">\(\alpha\)</span>, azimuth <span class="math inline">\(\theta\)</span>, and position of the zero <span class="math inline">\(\alpha\)</span>, we can calculate HRTF as below. <span class="math display">\[
\begin{array}{l}\omega_{0}=c / a \\ \alpha(\theta)=1.05+0.95 \cos \left(180^{o} \cdot \theta / 150^{o}\right) \\ H R T F=\frac{\left(\omega_{0}+\alpha f_{s}\right)+\left(\omega_{0}-\alpha f_{s}\right) z^{-1}}{\left(\omega_{0}+f_{s}\right)+\left(\omega_{0}-f_{s}\right) z^{-1}}\end{array}
\]</span> And we can model the first-order allpass filter as below. <span class="math display">\[
\tau_{h}(\theta)=\left\{\begin{array}{cc}-a(\cos \theta) / c &amp; \text { if } 0 \leq|\theta|&lt;\pi / 2 \\ a(|\theta|-\pi / 2) / c &amp; \text { if } \pi / 2 \leq|\theta|&lt;\pi\end{array}\right.
\]</span> Because human’s two ears are at different positions, with these formulas, the audio signal of two ears can be calculated separately.</p>
<h3 id="apples-implementation">Apple’s implementation</h3>
<p>Just as the following image shows, there is an Inertial Measurement Unit (IMU) in each AirPods Pro, and users’ head position can be calculated in real-time. With these head orientation signals, Apple Music can calculate the spatial audio in real-time. If users turn their heads left and right, they can tell that different audios come from a different direction.</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx2o1d6iq3j31bq0jmtau.jpg" alt="airpods_IMUs" style="zoom: 25%;" /></p>
<p>Actually, spatial audio had come up earlier than Apple's AirPods pro. Sony's PS4 and PS5 both have spatial audio with their specifically designed earphone. However, both of these devices are expensive, and not everyone has them (I have neither). So I implemented spatial audio with gyroscopes inside smartphones or cameras inside desktop computers.</p>
<h2 id="implementations">Implementations</h2>
<h3 id="imu-based-method">IMU-based Method</h3>
<p>Below is the diagram for IMU-based spatial audio.</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx2o1fzxv5j31fd0o2acg.jpg" alt="Gyro-based" style="zoom:33%;" /></p>
<p>In this Web-App, the user’s head position/direction will be measured with a gyroscope inside the smartphone. Users should keep the direction of the phone the same as their heads. And then the audio will be generated in real-time to mimic spatial audio.</p>
<p>We recommend that you tie your phone on top of your head, with the phone screen facing up, and the top of the phone facing the tip of your nose. Although it's not convenient to bind your phone on the top of your head, it can be widely used for everyone!</p>
<p>This web app can be found here: https://spatialaudio.omniai.org/spatial_audio_for_phones.html</p>
<h3 id="camera-based-method">Camera-based Method</h3>
<p>However, as wearing a mobile phone on top of your head is rather stupid, I decide to make a new version with the camera, as shown below.</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx2o1ebnx2j315a0svmzj.jpg" alt="Camera-based" style="zoom:33%;" /></p>
<p>In this solution, a TensorFlow model is used to generate face mesh, and then the direction of the head is calculated in real-time. There are two vectors, one is for the front, one is for the top of the head. And then the two channels of audio can be calculated in real-time with HRTF.</p>
<p>You could use your front camera to measure the face direction. Though there is a defect: your head can not turn back (or the camera can not find your face).</p>
<p>This web app can be found here: https://spatialaudio.omniai.org/spatial_audio_for_desktop.html</p>
<h3 id="final-version-with-audio-visualization">Final Version with Audio Visualization</h3>
<p>The camera-based solution is more convenient, and a web app with 3D demonstration is designed. In this app, users can upload their own audio files and can see the real-time audio in different channels.</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx2o1fbkb0j31t70u0wn2.jpg" /></p>
<p>The first page is (a), where users can try if this app works. If the human head moves as you move your head, it means it works, or you could try the previous implementations. in the second page (b), users can choose whether use mirror mode and can choose the audio file. On the third page (c), press the play button and then you can hear the audio. With the audio playing, you can even see the volume in each channel, as (d) shows. You can close some channels by pressing it, and then focus on one channel to experience the magic spatial audio on page (e).</p>
<p>This web app can be found here: https://spatialaudio.omniai.org/</p>
<h2 id="libraries-and-code">Libraries and code</h2>
<h3 id="web-apis">Web APIs</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioListener">API: AudioListener</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/PannerNode">API: PannerNode</a></li>
</ul>
<h3 id="libraries">Libraries</h3>
<ul>
<li>Three.js</li>
<li>TF.js</li>
<li><span class="citation" data-cites="tensorflow-models/facemesh">@tensorflow-models/facemesh</span></li>
<li>Semantic-UI</li>
</ul>
<h3 id="code-implementation">Code implementation</h3>
<ul>
<li>The zipped code can be found in attachments.</li>
<li>The GitHub repository is <a target="_blank" rel="noopener" href="https://github.com/bingcheng1998/DSP_Lab_project_spatial_audio">here</a>.</li>
</ul>
<h4 id="code-explaination">Code Explaination</h4>
<p>For this project, all functional code is in javascript format. The explanation of the <code>.js</code> files is below.</p>
<ul>
<li><code>orientation.js</code> get the orientation of smartphones</li>
<li><code>plot_head_movements.js</code> plot 3D head movement</li>
<li><code>ios_access.js</code> detect iOS devices</li>
<li><code>3d_spatial_audio.js</code> calculate real-time signal by smartphone orientation</li>
<li><code>cs_audio.js</code> calculate real-time signal by camera detection</li>
<li><code>cs_face_orientation.js</code> detect face orientation with tensorflow.js and then calculate the Euler Angles from direction vectors</li>
<li><code>desktop_face_orientation.js</code> detect face orientation with tensorflow.js</li>
<li><code>face_3d_spatial_audio.js</code> detect face orientation with tensorflow.js</li>
<li><code>multi_3d_spatial_audio.js</code> play different audio in different virtual position and then calculate the stereo spatial audio</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li>Cartesian coordinate system: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cartesian_coordinate_system">Wikipedia</a></li>
<li>Euler angles: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Euler_angles">Wikipedia</a></li>
<li>Phone Orientaion: <a target="_blank" rel="noopener" href="https://www.w3.org/TR/orientation-event/#description">W3C</a></li>
<li>Multichannel 7.1 and 5.1 Wav Test Files: <a target="_blank" rel="noopener" href="https://www.jensign.com/bdp95/7dot1voiced/index.html">jensign.com</a></li>
<li>7.1 surround sound: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/7.1_surround_sound">wikipedia</a></li>
<li>Spatial Audio Slides: <a target="_blank" rel="noopener" href="https://brightspace.nyu.edu/d2l/le/lessons/113891/topics/5203695">NYU BrightSpace</a></li>
<li>Web audio spatialization basics: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Web_audio_spatialization_basics">Moz://a</a></li>
</ul>

    </div>
</article>
        </main>
        <aside class="aside">
            <div class="close"></div>
            <section class="aside-section">
                
    <h1>Categories</h1>

    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/App-Development/">App Development</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/art/">art</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/art/review/">review</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/philosophy/">philosophy</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/philosophy/review/">review</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/philosophy/review/sociology/">sociology</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/program/">program</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/review/">review</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/review/AI/">AI</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/sociology/">sociology</a></li></ul>

            </section>
            <section class="aside-section">
                
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/">2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2018/">2018</a></li></ul>


            </section>
            <section class="aside-section tag">
                
    <h1>Tags</h1>

    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/App-Development/" rel="tag">App Development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/COVID-19/" rel="tag">COVID-19</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MIPS/" rel="tag">MIPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/algorithms/" rel="tag">algorithms</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ancient-Chinese/" rel="tag">ancient Chinese</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/art/" rel="tag">art</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/cerilog/" rel="tag">cerilog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/heap/" rel="tag">heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/philosophy/" rel="tag">philosophy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/program/" rel="tag">program</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/review/" rel="tag">review</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/selection/" rel="tag">selection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/sorting/" rel="tag">sorting</a></li></ul>

            </section>
        </aside>
    </div>
</body>

</html>